<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" type="image/x-icon" href="images/MDai 1.ico" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Course Payment | MDai</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        /* Modern Color Palette from home.html */
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --dark-gradient: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);

        --primary-color: #667eea;
        --secondary-color: #f093fb;
        --accent-color: #4facfe;
        --text-primary: #ffffff;
        --text-secondary: #b4b4b4;
        --background-dark: #0a0a0a;
        --background-card: rgba(255, 255, 255, 0.05);
        --border-color: rgba(255, 255, 255, 0.1);

        /* Shadows */
        --shadow-soft: 0 10px 40px rgba(0, 0, 0, 0.15);
        --shadow-hard: 0 20px 60px rgba(0, 0, 0, 0.3);
        --glow: 0 0 30px rgba(102, 126, 234, 0.3);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Inter", sans-serif;
        background: var(--background-dark);
        padding: 40px 20px;
        color: var(--text-primary);
        overflow-x: hidden;
        min-height: 100vh;
        position: relative;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
            circle at 20% 50%,
            rgba(102, 126, 234, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 20%,
            rgba(240, 147, 251, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 40% 80%,
            rgba(79, 172, 254, 0.1) 0%,
            transparent 50%
          );
        z-index: -1;
        animation: float 20s ease-in-out infinite;
      }
      .payment-container {
        max-width: 600px;
        margin: 0 auto;
        background: var(--background-card);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        padding: 40px 35px;
        border-radius: 24px;
        box-shadow: var(--shadow-hard);
        animation: slideFade 0.8s ease;
        position: relative;
      }
      @keyframes slideFade {
        from {
          opacity: 0;
          transform: translateY(60px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .payment-container h2 {
        text-align: center;
        margin-bottom: 35px;
        font-size: 2.2rem;
        font-family: "Space Grotesk", sans-serif;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
        letter-spacing: -0.02em;
      }
      .payment-container h2::after {
        content: "";
        display: block;
        width: 80px;
        height: 4px;
        background: var(--accent-gradient);
        margin: 15px auto 0;
        border-radius: 4px;
      }
      .payment-container label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.95rem;
      }

      .payment-container input,
      .payment-container select {
        width: 100%;
        padding: 16px 20px;
        border: 1px solid var(--border-color);
        border-radius: 16px;
        font-size: 1rem;
        margin-bottom: 20px;
        background: rgba(255, 255, 255, 0.03);
        color: var(--text-primary);
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .payment-container input::placeholder {
        color: var(--text-secondary);
      }

      .payment-container input:focus,
      .payment-container select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        background: rgba(255, 255, 255, 0.08);
        outline: none;
        transform: translateY(-2px);
      }
      .payment-container button {
        width: 100%;
        padding: 18px;
        background: var(--primary-gradient);
        color: white;
        font-size: 1.1rem;
        font-weight: 600;
        border: none;
        border-radius: 16px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        box-shadow: var(--shadow-hard);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .payment-container button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .payment-container button:hover::before {
        left: 100%;
      }

      .payment-container button:hover {
        transform: translateY(-3px);
        box-shadow: 0 25px 70px rgba(102, 126, 234, 0.4);
      }
      .info-banner {
        background: var(--background-card);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 20px 25px;
        border-radius: 16px;
        text-align: center;
        max-width: 600px;
        margin: 0 auto 40px;
        font-size: 1.1rem;
        box-shadow: var(--shadow-soft);
        animation: pulse 2s infinite;
        line-height: 1.6;
      }

      .info-banner strong {
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          box-shadow: var(--shadow-soft);
        }
        50% {
          transform: scale(1.02);
          box-shadow: var(--shadow-hard);
        }
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-20px);
        }
      }

      /* Spinner Animation for Receipt Generation */
      .lds-spinner {
        display: inline-block;
        position: relative;
        width: 80px;
        height: 80px;
      }
      .lds-spinner div {
        transform-origin: 40px 40px;
        animation: lds-spinner 1.2s linear infinite;
      }
      .lds-spinner div:after {
        content: " ";
        display: block;
        position: absolute;
        top: 3px;
        left: 37px;
        width: 6px;
        height: 18px;
        border-radius: 20%;
        background: var(--primary-color);
      }
      .lds-spinner div:nth-child(1) {
        transform: rotate(0deg);
        animation-delay: -1.1s;
      }
      .lds-spinner div:nth-child(2) {
        transform: rotate(30deg);
        animation-delay: -1s;
      }
      .lds-spinner div:nth-child(3) {
        transform: rotate(60deg);
        animation-delay: -0.9s;
      }
      .lds-spinner div:nth-child(4) {
        transform: rotate(90deg);
        animation-delay: -0.8s;
      }
      .lds-spinner div:nth-child(5) {
        transform: rotate(120deg);
        animation-delay: -0.7s;
      }
      .lds-spinner div:nth-child(6) {
        transform: rotate(150deg);
        animation-delay: -0.6s;
      }
      .lds-spinner div:nth-child(7) {
        transform: rotate(180deg);
        animation-delay: -0.5s;
      }
      .lds-spinner div:nth-child(8) {
        transform: rotate(210deg);
        animation-delay: -0.4s;
      }
      .lds-spinner div:nth-child(9) {
        transform: rotate(240deg);
        animation-delay: -0.3s;
      }
      .lds-spinner div:nth-child(10) {
        transform: rotate(270deg);
        animation-delay: -0.2s;
      }
      .lds-spinner div:nth-child(11) {
        transform: rotate(300deg);
        animation-delay: -0.1s;
      }
      .lds-spinner div:nth-child(12) {
        transform: rotate(330deg);
        animation-delay: 0s;
      }
      @keyframes lds-spinner {
        0% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      @media (max-width: 600px) {
        .payment-container {
          padding: 30px 20px;
          margin: 0 10px;
        }
        .info-banner {
          margin: 0 10px 30px;
          padding: 18px 20px;
          font-size: 1rem;
        }
        .payment-container h2 {
          font-size: 1.8rem;
        }
      }

      /* M-pesa button */
      .view-mpesa-btn {
        display: block;
        margin: 25px auto;
        padding: 16px 32px;
        font-size: 1.1rem;
        font-weight: 600;
        background: var(--accent-gradient);
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: var(--shadow-hard);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .view-mpesa-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .view-mpesa-btn:hover::before {
        left: 100%;
      }

      .view-mpesa-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 25px 70px rgba(79, 172, 254, 0.4);
      }

      .mpesa-box {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
        visibility: hidden;
        opacity: 0;
        transition: all 0.4s ease;
      }
      .mpesa-box.active {
        visibility: visible;
        opacity: 1;
      }

      .mpesa-content {
        background: var(--background-card);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        padding: 40px 35px;
        border-radius: 24px;
        box-shadow: var(--shadow-hard);
        text-align: center;
        animation: bounceIn 0.6s ease;
        max-width: 420px;
        width: 90%;
        position: relative;
      }

      .mpesa-content h3 {
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 20px;
      }

      .mpesa-number {
        font-size: 1.8rem;
        font-weight: bold;
        margin: 15px 0;
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        cursor: pointer;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        background-color: rgba(255, 255, 255, 0.05);
        transition: all 0.3s ease;
      }
      .mpesa-number:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-soft);
        background-color: rgba(255, 255, 255, 0.1);
      }

      .mpesa-msg {
        font-size: 1rem;
        color: var(--text-secondary);
        margin-bottom: 25px;
        line-height: 1.6;
      }

      .close-btn {
        padding: 14px 28px;
        background: var(--primary-gradient);
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-soft);
        position: relative;
        overflow: hidden;
      }

      .close-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .close-btn:hover::before {
        left: 100%;
      }

      .close-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hard);
      }

      .copied {
        position: absolute;
        top: 0;
        right: 0;
        margin: 10px;
        font-size: 0.85rem;
        color: green;
        display: none;
        animation: fadeInOut 2s ease-in-out;
      }

      @keyframes bounceIn {
        0% {
          transform: scale(0.5);
          opacity: 0;
        }
        60% {
          transform: scale(1.1);
          opacity: 1;
        }
        100% {
          transform: scale(1);
        }
      }
      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translateY(-10px);
        }
        30% {
          opacity: 1;
          transform: translateY(0);
        }
        70% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translateY(-10px);
        }
      }

      .lds-spinner {
        color: official;
        display: inline-block;
        position: relative;
        width: 80px;
        height: 80px;
      }
      .lds-spinner div {
        transform-origin: 40px 40px;
        animation: lds-spinner 1.2s linear infinite;
      }
      .lds-spinner div:after {
        content: " ";
        display: block;
        position: absolute;
        top: 3px;
        left: 37px;
        width: 6px;
        height: 18px;
        border-radius: 20%;
        background: var(--primary-color);
      }
      .lds-spinner div:nth-child(1) {
        transform: rotate(0deg);
        animation-delay: -1.1s;
      }
      .lds-spinner div:nth-child(2) {
        transform: rotate(30deg);
        animation-delay: -1s;
      }
      .lds-spinner div:nth-child(3) {
        transform: rotate(60deg);
        animation-delay: -0.9s;
      }
      .lds-spinner div:nth-child(4) {
        transform: rotate(90deg);
        animation-delay: -0.8s;
      }
      .lds-spinner div:nth-child(5) {
        transform: rotate(120deg);
        animation-delay: -0.7s;
      }
      .lds-spinner div:nth-child(6) {
        transform: rotate(150deg);
        animation-delay: -0.6s;
      }
      .lds-spinner div:nth-child(7) {
        transform: rotate(180deg);
        animation-delay: -0.5s;
      }
      .lds-spinner div:nth-child(8) {
        transform: rotate(210deg);
        animation-delay: -0.4s;
      }
      .lds-spinner div:nth-child(9) {
        transform: rotate(240deg);
        animation-delay: -0.3s;
      }
      .lds-spinner div:nth-child(10) {
        transform: rotate(270deg);
        animation-delay: -0.2s;
      }
      .lds-spinner div:nth-child(11) {
        transform: rotate(300deg);
        animation-delay: -0.1s;
      }
      .lds-spinner div:nth-child(12) {
        transform: rotate(330deg);
        animation-delay: 0s;
      }

      @keyframes lds-spinner {
        0% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      /* Enhanced Payment Methods */
      .payment-methods-container {
        margin-bottom: 30px;
      }

      .payment-methods-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
      }

      .payment-method-card {
        background: var(--background-card);
        border: 2px solid var(--border-color);
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(20px);
        position: relative;
      }

      .payment-method-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary-color);
        box-shadow: var(--shadow-soft);
      }

      .payment-method-card.selected {
        border-color: var(--primary-color);
        background: rgba(102, 126, 234, 0.1);
        box-shadow: var(--glow);
      }

      .payment-method-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .payment-method-title {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 5px;
      }

      .payment-method-desc {
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      /* Security & Trust Elements */
      .security-badges {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin: 25px 0;
        padding: 15px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 12px;
        border: 1px solid var(--border-color);
      }

      .security-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .security-badge i {
        color: #22c55e;
      }

      /* Form Validation States */
      .form-group {
        position: relative;
        margin-bottom: 25px;
      }

      .form-group.error input {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
      }

      .form-group.success input {
        border-color: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
      }

      .error-message {
        color: #ef4444;
        font-size: 0.85rem;
        margin-top: 5px;
        display: none;
      }

      .form-group.error .error-message {
        display: block;
      }

      .success-message {
        color: #22c55e;
        font-size: 0.85rem;
        margin-top: 5px;
        display: none;
      }

      .form-group.success .success-message {
        display: block;
      }

      /* Payment Progress Indicator */
      .payment-progress {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        background: var(--background-card);
        border-radius: 16px;
        border: 1px solid var(--border-color);
      }

      .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
      }

      .progress-step:not(:last-child)::after {
        content: "";
        position: absolute;
        top: 20px;
        right: -50%;
        width: 100%;
        height: 2px;
        background: var(--border-color);
        z-index: 1;
      }

      .progress-step.active::after {
        background: var(--primary-color);
      }

      .progress-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        position: relative;
        z-index: 2;
        transition: all 0.3s ease;
      }

      .progress-step.active .progress-icon {
        background: var(--primary-gradient);
        color: white;
      }

      .progress-step.completed .progress-icon {
        background: #22c55e;
        color: white;
      }

      .progress-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        text-align: center;
      }

      .progress-step.active .progress-label {
        color: var(--text-primary);
        font-weight: 600;
      }

      /* Pricing Breakdown */
      .pricing-breakdown {
        background: var(--background-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 25px;
        backdrop-filter: blur(20px);
      }

      .pricing-breakdown h3 {
        color: var(--text-primary);
        margin-bottom: 20px;
        font-size: 1.2rem;
        font-weight: 600;
      }

      .pricing-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid var(--border-color);
      }

      .pricing-item:last-child {
        border-bottom: none;
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--text-primary);
        margin-top: 10px;
        padding-top: 15px;
        border-top: 2px solid var(--border-color);
      }

      .pricing-label {
        color: var(--text-secondary);
      }

      .pricing-value {
        color: var(--text-primary);
        font-weight: 600;
      }

      .total-amount {
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 1.3rem !important;
      }

      /* Enhanced Mobile Responsiveness */
      @media (max-width: 768px) {
        .payment-methods-grid {
          grid-template-columns: 1fr;
        }

        .security-badges {
          flex-direction: column;
          gap: 10px;
        }

        .payment-progress {
          padding: 15px 10px;
        }

        .progress-step {
          flex: none;
          margin: 0 5px;
        }

        .progress-step:not(:last-child)::after {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="info-banner" id="infoBanner"></div>
    <div class="payment-container">
      <h2><i class="fas fa-credit-card"></i> Paiement du cours</h2>

      <!-- Payment Progress Indicator -->
      <div class="payment-progress">
        <div class="progress-step active" id="step1">
          <div class="progress-icon">
            <i class="fas fa-user"></i>
          </div>
          <div class="progress-label">Informations</div>
        </div>
        <div class="progress-step" id="step2">
          <div class="progress-icon">
            <i class="fas fa-credit-card"></i>
          </div>
          <div class="progress-label">Paiement</div>
        </div>
        <div class="progress-step" id="step3">
          <div class="progress-icon">
            <i class="fas fa-check"></i>
          </div>
          <div class="progress-label">Confirmation</div>
        </div>
      </div>

      <!-- Pricing Breakdown -->
      <div class="pricing-breakdown" id="pricingBreakdown">
        <h3><i class="fas fa-receipt"></i> Détails du prix</h3>
        <div class="pricing-item">
          <span class="pricing-label">Cours:</span>
          <span class="pricing-value" id="coursePrice">$0</span>
        </div>
        <div class="pricing-item">
          <span class="pricing-label">Frais d'inscription:</span>
          <span class="pricing-value" id="regFee">$0</span>
        </div>
        <div class="pricing-item">
          <span class="pricing-label total-amount">Total:</span>
          <span class="pricing-value total-amount" id="totalPrice">$0</span>
        </div>
      </div>

      <!-- Payment Methods Selection -->
      <div class="payment-methods-container">
        <h3
          style="
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.2rem;
          "
        >
          <i class="fas fa-wallet"></i> Choisissez votre méthode de paiement
        </h3>
        <div class="payment-methods-grid">
          <div
            class="payment-method-card"
            data-method="card"
            onclick="selectPaymentMethod('card')"
          >
            <div class="payment-method-icon">
              <i class="fas fa-credit-card"></i>
            </div>
            <div class="payment-method-title">Carte Bancaire</div>
            <div class="payment-method-desc">Visa, Mastercard, Amex</div>
          </div>
          <div
            class="payment-method-card"
            data-method="mobile"
            onclick="selectPaymentMethod('mobile')"
          >
            <div class="payment-method-icon">
              <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="payment-method-title">M-PESA</div>
            <div class="payment-method-desc">Paiement mobile sécurisé</div>
          </div>
        </div>
      </div>

      <!-- Security Badges -->
      <div class="security-badges">
        <div class="security-badge">
          <i class="fas fa-shield-alt"></i>
          <span>Sécurisé SSL</span>
        </div>
        <div class="security-badge">
          <i class="fas fa-lock"></i>
          <span>Crypté 256-bit</span>
        </div>
        <div class="security-badge">
          <i class="fas fa-user-shield"></i>
          <span>Données protégées</span>
        </div>
      </div>

      <!-- M-PESA Button and Modal -->
      <button
        class="view-mpesa-btn"
        onclick="showMpesa()"
        id="mpesaBtn"
        style="display: none"
      >
        <i class="fas fa-mobile-alt"></i> Afficher le numéro M-PESA
      </button>

      <div class="mpesa-box" id="mpesaBox">
        <div class="mpesa-content">
          <h3><i class="fas fa-mobile-alt"></i> M-PESA Payment</h3>
          <p class="mpesa-number" onclick="copyMpesa()">+243 812 336 721</p>
          <p class="mpesa-msg">
            Payez à ce numéro avant de remplir la section de paiement
          </p>
          <p class="mpesa-msg">Nom: MADELEINE AMURI MARIAMO</p>
          <span id="copy-feedback" class="copied">Copié !</span>
          <button onclick="hideMpesa()" class="close-btn">
            <i class="fas fa-times"></i> Fermer
          </button>
        </div>
      </div>

      <form id="paymentForm">
        <div class="form-group">
          <label for="to_name">
            <i class="fas fa-user"></i> Nom complet:
          </label>
          <input
            type="text"
            name="to_name"
            placeholder="Entrez votre nom complet"
            required
          />
          <div class="error-message">Veuillez entrer un nom valide</div>
          <div class="success-message">Nom valide ✓</div>
        </div>

        <div class="form-group">
          <label for="email">
            <i class="fas fa-envelope"></i> Adresse e-mail:
          </label>
          <input
            type="email"
            name="email"
            placeholder="votre.email@exemple.com"
            required
          />
          <div class="error-message">
            Veuillez entrer une adresse e-mail valide
          </div>
          <div class="success-message">Adresse e-mail valide ✓</div>
        </div>

        <div class="form-group">
          <label for="amount">
            <i class="fas fa-dollar-sign"></i> Montant:
          </label>
          <input
            type="number"
            id="amount"
            name="amount"
            placeholder="Montant (USD ou FC)"
            required
            readonly
          />
          <div class="error-message">Montant invalide</div>
          <div class="success-message">Montant confirmé ✓</div>
        </div>

        <input type="hidden" name="payment_method" id="selectedPaymentMethod" />
        <input type="hidden" id="course_title" name="course_title" />
        <input type="hidden" id="course_info" name="course_info" />
        <input type="hidden" id="course_price" name="course_price" />
        <input type="hidden" id="registration_fee" name="registration_fee" />
        <input type="hidden" id="total_amount" name="total_amount" />

        <button type="submit" id="paymentButton" disabled>
          <i class="fas fa-credit-card"></i>
          <span id="buttonText">Sélectionnez une méthode de paiement</span>
        </button>
      </form>

      <!-- Receipt History Button -->
      <div
        style="
          text-align: center;
          margin-top: 20px;
          padding-top: 20px;
          border-top: 1px solid var(--border-color);
        "
      >
        <button
          type="button"
          onclick="viewReceiptHistory()"
          style="
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
          "
          onmouseover="this.style.borderColor='var(--accent-color)'; this.style.color='var(--text-primary)'; this.style.background='rgba(79, 172, 254, 0.1)';"
          onmouseout="this.style.borderColor='var(--border-color)'; this.style.color='var(--text-secondary)'; this.style.background='transparent';"
        >
          <i class="fas fa-history"></i>
          Voir l'Historique des Reçus
        </button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script>
      // Global variables
      let selectedPaymentMethod = null;
      let isFormValid = false;

      document.addEventListener("DOMContentLoaded", function () {
        // Initialize EmailJS with error handling
        try {
          if (typeof emailjs !== "undefined") {
            emailjs.init("px88hVvZZOI8odox8");
            console.log("EmailJS initialized successfully");
          } else {
            console.warn("EmailJS not loaded");
          }
        } catch (emailjsError) {
          console.error("EmailJS initialization failed:", emailjsError);
        }

        // Check if required libraries are loaded
        if (typeof jsPDF === "undefined") {
          console.error("jsPDF library not loaded");
        }
        if (typeof QRCode === "undefined") {
          console.error("QRCode library not loaded");
        }
        if (typeof Swal === "undefined") {
          console.error("SweetAlert2 library not loaded");
        }

        // Initialize course data
        const title = localStorage.getItem("selectedCourseTitle") || "";
        const info = localStorage.getItem("selectedCourseInfo") || "";
        const price = localStorage.getItem("coursePrice") || "";
        const fee = localStorage.getItem("registrationFee") || "";
        const total = localStorage.getItem("selectedCourseTotal") || "";
        const match = total.match(/([\d,.]+)\s?(FC|USD)?/i);
        let amount = match ? parseFloat(match[1].replace(",", "")) : "";

        document.getElementById("course_title").value = title;
        document.getElementById("course_info").value = info;
        document.getElementById("course_price").value = price;
        document.getElementById("registration_fee").value = fee;
        document.getElementById("total_amount").value = total;
        document.getElementById("amount").value = amount;

        // Update pricing breakdown
        document.getElementById("coursePrice").textContent = price;
        document.getElementById("regFee").textContent = fee;
        document.getElementById("totalPrice").textContent = total;

        document.getElementById(
          "infoBanner"
        ).innerHTML = `Vous avez sélectionné <strong>${title}</strong><br>${info}<br>Course: <strong>${price}</strong> | Fee: <strong>${fee}</strong><br>Total: <strong>${total}</strong>`;

        // Initialize form validation
        console.log("Initializing form validation...");
        initializeFormValidation();

        // Add debug listener to check if form submission is working
        const form = document.getElementById("paymentForm");
        if (form) {
          console.log("✅ Form element found and accessible");

          // Add a test click handler to see if events work
          form.addEventListener("click", function () {
            console.log("🔘 Form clicked (general event test)");
          });
        } else {
          console.error("❌ Form element not found!");
        }

        const button = document.getElementById("paymentButton");
        if (button) {
          console.log("✅ Payment button found");
          button.addEventListener("click", function (e) {
            console.log("🔘 Payment button clicked!");
            console.log("Button disabled?", button.disabled);
            console.log("Form valid?", isFormValid);
            console.log("Payment method?", selectedPaymentMethod);

            // If button is disabled, prevent default
            if (button.disabled) {
              console.log("⛔ Button is disabled - preventing submission");
              e.preventDefault();
              return false;
            }
          });
        } else {
          console.error("❌ Payment button not found!");
        }

        // Comprehensive form validation function
        function validatePaymentForm(payload, paymentMethod) {
          if (!payload.to_name || payload.to_name.length < 2) {
            return {
              isValid: false,
              message: "Veuillez entrer un nom valide (au moins 2 caractères).",
            };
          }

          if (!payload.email || !isValidEmail(payload.email)) {
            return {
              isValid: false,
              message: "Veuillez entrer une adresse email valide.",
            };
          }

          if (!payload.amount || parseFloat(payload.amount) <= 0) {
            return {
              isValid: false,
              message: "Veuillez entrer un montant valide.",
            };
          }

          if (!paymentMethod) {
            return {
              isValid: false,
              message: "Veuillez sélectionner une méthode de paiement.",
            };
          }

          return { isValid: true, message: "Validation réussie" };
        }

        function isValidEmail(email) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailRegex.test(email);
        }

        // Add form submission handler with enhanced debugging
        const paymentForm = document.getElementById("paymentForm");
        if (paymentForm) {
          console.log("✅ Adding form submission event listener");
          paymentForm.addEventListener("submit", async function (e) {
            e.preventDefault();
            console.log(
              "🚀 Payment form submission started - Event triggered!"
            );
            console.log("Form element:", this);
            console.log("Event:", e);

            // Collect and validate form data
            const formData = new FormData(this);
            const payload = {};

            // Convert FormData to object with validation
            for (let [key, value] of formData.entries()) {
              payload[key] = value.trim();
            }

            console.log("📋 Form payload:", payload);
            console.log("💳 Selected payment method:", selectedPaymentMethod);

            // Comprehensive form validation
            const validationResult = validatePaymentForm(
              payload,
              selectedPaymentMethod
            );
            if (!validationResult.isValid) {
              // Highlight the problematic field
              if (!payload.to_name || payload.to_name.length < 2) {
                const nameInput = document.querySelector(
                  'input[name="to_name"]'
                );
                nameInput.focus();
                nameInput.style.borderColor = "#dc3545";
                setTimeout(() => (nameInput.style.borderColor = ""), 3000);
              } else if (!payload.email || !isValidEmail(payload.email)) {
                const emailInput = document.querySelector(
                  'input[name="email"]'
                );
                emailInput.focus();
                emailInput.style.borderColor = "#dc3545";
                setTimeout(() => (emailInput.style.borderColor = ""), 3000);
              }

              return Swal.fire({
                icon: "warning",
                title: "⚠️ Données Manquantes",
                text: validationResult.message,
                confirmButtonColor: "#667eea",
                background: "#1a1a1a",
                color: "#ffffff",
              });
            }

            // Add payment method and course data to payload
            payload.payment_method = selectedPaymentMethod;
            payload.course_title =
              payload.course_title ||
              localStorage.getItem("selectedCourseTitle") ||
              "Cours MDai";
            payload.course_info =
              payload.course_info ||
              localStorage.getItem("selectedCourseInfo") ||
              "Formation IA";
            payload.total_amount = payload.total_amount || payload.amount;

            console.log("✅ Validation passed, processing payment...");

            // Progress to step 3
            updateProgressStep(3);

            try {
              console.log("💫 Starting payment processing...");

              // Show processing animation
              Swal.fire({
                title: "🧠 MDai - Traitement Intelligent",
                html: `
                  <div style="padding: 20px;">
                    <div class="lds-spinner">
                      <div></div><div></div><div></div><div></div><div></div><div></div>
                      <div></div><div></div><div></div><div></div><div></div><div></div>
                    </div>
                    <p style="margin-top: 15px; font-size: 1rem; color: #667eea;">
                      Traitement intelligent de votre paiement...
                    </p>
                    <div style="margin-top: 10px; font-size: 0.9rem; color: #888;">
                      ✓ Validation des données<br>
                      ✓ Génération du reçu<br>
                      ✓ Envoi par email<br>
                      ✓ Finalisation automatique
                    </div>
                  </div>
                `,
                allowOutsideClick: false,
                showConfirmButton: false,
                background: "#1a1a1a",
                color: "#ffffff",
              });

              // Generate unique receipt ID
              const timestamp = Date.now();
              const randomNum = Math.floor(Math.random() * 1000);
              const receiptId = `MDai${timestamp}${randomNum}`;

              console.log("📄 Generated receipt ID:", receiptId);

              // Prepare comprehensive receipt data
              const receiptData = {
                id: receiptId,
                date: new Date().toISOString(),
                customerName: payload.to_name,
                email: payload.email,
                course: payload.course_title,
                courseInfo: payload.course_info,
                amount: payload.total_amount || payload.amount,
                paymentMethod: payload.payment_method,
                timestamp: new Date().toLocaleString("fr-FR"),
              };

              // Process payment and generate receipt using FormData
              const formDataObj = new FormData();
              formDataObj.append("to_name", payload.to_name);
              formDataObj.append("email", payload.email);
              formDataObj.append("phone", payload.phone || "");
              formDataObj.append(
                "amount",
                payload.total_amount || payload.amount
              );

              const result = await processPaymentAndGenerateReceipt(
                formDataObj
              );

              if (result.success) {
                // Payment processed successfully, show final success message
                await Swal.fire({
                  icon: "success",
                  title: "✅ Paiement Réussi !",
                  html: `
                    <div style="text-align: left; padding: 15px; background: rgba(40, 167, 69, 0.1); border-radius: 10px; margin: 10px 0;">
                      <h4 style="color: #28a745; margin-bottom: 10px;">📋 Détails de la Transaction</h4>
                      <p><strong>ID Transaction :</strong> ${
                        result.data.transactionId
                      }</p>
                      <p><strong>Montant :</strong> ${result.data.amount.toFixed(
                        2
                      )} €</p>
                      <p><strong>Méthode :</strong> ${
                        result.data.paymentMethod
                      }</p>
                      <p><strong>Date :</strong> ${result.data.date} à ${
                    result.data.time
                  }</p>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                      <p style="color: #28a745; font-weight: bold;">✅ Reçu téléchargé automatiquement</p>
                      <p style="color: #007bff;">📧 Email de confirmation envoyé</p>
                      <p style="color: #6c757d; font-size: 0.9em; margin-top: 10px;">
                        Redirection automatique dans 3 secondes...
                      </p>
                    </div>
                  `,
                  confirmButtonColor: "#28a745",
                  confirmButtonText: "Parfait !",
                  timer: 5000,
                  timerProgressBar: true,
                  background: "#1a1a1a",
                  color: "#ffffff",
                });

                // Redirect to home
                setTimeout(() => {
                  window.location.href = "home.html";
                }, 3000);

                return; // Exit the function as processing is complete
              }

              // If we reach here, something went wrong
              throw new Error("Payment processing failed");

              // Legacy PDF creation code (fallback - should not be reached)
              try {
                // Background image with fallback
                try {
                  const bg = new Image();
                  bg.src = "images/MDai.png";
                  await new Promise((resolve, reject) => {
                    bg.onload = resolve;
                    bg.onerror = () => resolve(); // Continue without background
                    setTimeout(reject, 3000); // Timeout after 3 seconds
                  }).catch(() =>
                    console.log("Background image failed to load")
                  );

                  if (bg.complete && bg.naturalHeight !== 0) {
                    doc.addImage(bg, "PNG", 170, 10, 30, 30);
                  }
                } catch (e) {
                  console.log("Background image error:", e);
                }

                // Header
                doc.setTextColor(102, 126, 234);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(24);
                doc.text("REÇU DE PAIEMENT", 20, 30);

                doc.setTextColor(79, 172, 254);
                doc.setFontSize(18);
                doc.text("MDai Platform", 20, 45);

                // Receipt details
                doc.setTextColor(0, 0, 0);
                doc.setFont("helvetica", "normal");
                doc.setFontSize(12);

                let y = 70;
                const receiptData = [
                  `N° de Reçu: ${receiptId}`,
                  `Date: ${new Date().toLocaleDateString("fr-FR")}`,
                  ``,
                  `INFORMATIONS CLIENT:`,
                  `Nom: ${payload.to_name}`,
                  `Email: ${payload.email}`,
                  ``,
                  `DÉTAILS DU COURS:`,
                  `Cours: ${payload.course_title || "Cours MDai"}`,
                  `Description: ${
                    payload.course_info ||
                    "Formation en Intelligence Artificielle"
                  }`,
                  `Prix du cours: ${payload.course_price || payload.amount}`,
                  `Frais d'inscription: ${payload.registration_fee || "0"}`,
                  `TOTAL PAYÉ: ${payload.total_amount || payload.amount}`,
                  `Méthode de paiement: ${payload.payment_method}`,
                ];

                receiptData.forEach((line, index) => {
                  if (
                    line.includes("INFORMATIONS CLIENT:") ||
                    line.includes("DÉTAILS DU COURS:")
                  ) {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(14);
                  } else if (line.includes("TOTAL PAYÉ:")) {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(13);
                    doc.setTextColor(0, 128, 0);
                  } else {
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                  }

                  if (line.trim()) {
                    doc.text(line, 20, y);
                  }
                  y += 8;
                });

                // Thank you message
                doc.setTextColor(0, 128, 0);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text("Merci pour votre confiance!", 20, y + 20);

                // Signature
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(11);
                doc.setFont("helvetica", "italic");
                doc.text("_______________________", 20, y + 50);
                doc.text("Symphorien Pyana", 20, y + 57);
                doc.text("CEO, MDai Platform", 20, y + 64);

                // Footer
                doc.setTextColor(150, 150, 150);
                doc.setFontSize(10);
                doc.text(
                  "MDai Platform | www.mdai.xyz | contact@mdai.xyz",
                  20,
                  280
                );

                // QR Code with error handling
                try {
                  const qrData = `Reçu: ${receiptId}\nClient: ${
                    payload.to_name
                  }\nCours: ${
                    payload.course_title || "MDai Course"
                  }\nMontant: ${payload.amount}`;
                  const qrImage = await QRCode.toDataURL(qrData);
                  doc.addImage(qrImage, "PNG", 150, y + 30, 40, 40);
                } catch (qrError) {
                  console.log("QR Code generation failed:", qrError);
                }
              } catch (pdfError) {
                console.error("PDF generation error:", pdfError);
                throw new Error("Erreur lors de la génération du PDF");
              }

              // Call the automatic receipt generation
              await generateAutomaticReceipt(doc, receiptId, payload);

              // Send email with error handling
              try {
                if (typeof emailjs !== "undefined") {
                  await emailjs.send("service_osvola7", "template_12nvate", {
                    ...payload,
                    receipt_number: receiptId,
                    to_email: payload.email,
                    to_name: payload.to_name,
                  });
                  console.log("Email sent successfully");
                } else {
                  throw new Error("EmailJS not available");
                }
              } catch (emailError) {
                console.error("Email sending failed:", emailError);
                // Don't stop the process if email fails - continue with success message
                console.log("Continuing without email notification");
              }

              // Reset form and clear storage
              this.reset();
              selectedPaymentMethod = null;
            } catch (err) {
              console.error("Payment processing error:", err);
              Swal.fire({
                icon: "error",
                title: "Erreur de Traitement",
                text:
                  err.message ||
                  "Une erreur s'est produite lors du traitement du paiement. Veuillez réessayer.",
                confirmButtonColor: "#667eea",
              });
            }
          });
        } else {
          console.error(
            "❌ Form element not found - cannot attach event listener!"
          );
        }
      });

      // Comprehensive Payment Processing Function
      async function processPaymentAndGenerateReceipt(formData) {
        console.log("Starting comprehensive payment processing...");

        try {
          // Step 1: Validate all required libraries
          if (typeof jsPDF === "undefined") {
            throw new Error("PDF generation library not available");
          }

          if (typeof emailjs === "undefined") {
            console.warn(
              "Email service not available, continuing without email"
            );
          }

          // Step 2: Process payment data
          const paymentData = {
            name: formData.get("to_name") || formData.get("name"),
            email: formData.get("email"),
            phone: formData.get("phone") || "Non spécifié",
            amount: parseFloat(formData.get("amount")),
            paymentMethod: selectedPaymentMethod,
            transactionId:
              "TXN" + Date.now() + Math.random().toString(36).substr(2, 9),
            date: new Date().toLocaleDateString("fr-FR"),
            time: new Date().toLocaleTimeString("fr-FR"),
            courseName: "Formation IA - OpenMind Digital Academy",
          };

          console.log("Payment data processed:", paymentData);

          // Step 3: Generate PDF Receipt
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          // PDF Header
          doc.setFillColor(102, 126, 234);
          doc.rect(0, 0, 210, 30, "F");

          doc.setTextColor(255, 255, 255);
          doc.setFontSize(20);
          doc.setFont(undefined, "bold");
          doc.text("REÇU DE PAIEMENT", 105, 20, { align: "center" });

          // Reset color for content
          doc.setTextColor(0, 0, 0);
          doc.setFontSize(12);
          doc.setFont(undefined, "normal");

          // Receipt content
          let yPosition = 50;

          doc.setFont(undefined, "bold");
          doc.text("Détails de la Transaction:", 20, yPosition);
          yPosition += 10;

          doc.setFont(undefined, "normal");
          doc.text(
            `ID Transaction: ${paymentData.transactionId}`,
            25,
            yPosition
          );
          yPosition += 8;
          doc.text(`Date: ${paymentData.date}`, 25, yPosition);
          yPosition += 8;
          doc.text(`Heure: ${paymentData.time}`, 25, yPosition);
          yPosition += 15;

          doc.setFont(undefined, "bold");
          doc.text("Informations Client:", 20, yPosition);
          yPosition += 10;

          doc.setFont(undefined, "normal");
          doc.text(`Nom: ${paymentData.name}`, 25, yPosition);
          yPosition += 8;
          doc.text(`Email: ${paymentData.email}`, 25, yPosition);
          yPosition += 8;
          doc.text(`Téléphone: ${paymentData.phone}`, 25, yPosition);
          yPosition += 15;

          doc.setFont(undefined, "bold");
          doc.text("Détails du Cours:", 20, yPosition);
          yPosition += 10;

          doc.setFont(undefined, "normal");
          doc.text(`Formation: ${paymentData.courseName}`, 25, yPosition);
          yPosition += 8;
          doc.text(
            `Montant: ${paymentData.amount.toFixed(2)} €`,
            25,
            yPosition
          );
          yPosition += 8;
          doc.text(
            `Méthode de paiement: ${paymentData.paymentMethod}`,
            25,
            yPosition
          );
          yPosition += 15;

          // Footer
          doc.setFillColor(240, 240, 240);
          doc.rect(0, yPosition, 210, 20, "F");

          doc.setTextColor(100, 100, 100);
          doc.setFontSize(10);
          doc.text(
            "OpenMind Digital Academy - Formation en Intelligence Artificielle",
            105,
            yPosition + 10,
            { align: "center" }
          );
          doc.text("Merci pour votre confiance !", 105, yPosition + 15, {
            align: "center",
          });

          // Step 4: Save PDF and show success
          const pdfBlob = doc.output("blob");
          const pdfUrl = URL.createObjectURL(pdfBlob);

          // Download PDF
          const downloadLink = document.createElement("a");
          downloadLink.href = pdfUrl;
          downloadLink.download = `Recu_${paymentData.transactionId}.pdf`;
          downloadLink.click();

          console.log("PDF generated and downloaded successfully");

          // Step 5: Store transaction in localStorage
          const transactions = JSON.parse(
            localStorage.getItem("transactions") || "[]"
          );
          transactions.push(paymentData);
          localStorage.setItem("transactions", JSON.stringify(transactions));

          // Step 6: Send email if available
          if (typeof emailjs !== "undefined") {
            try {
              const emailParams = {
                to_name: paymentData.name,
                to_email: paymentData.email,
                transaction_id: paymentData.transactionId,
                amount: paymentData.amount.toFixed(2),
                course_name: paymentData.courseName,
                payment_method: paymentData.paymentMethod,
                date: paymentData.date,
                time: paymentData.time,
              };

              await emailjs.send(
                "service_osvola7",
                "template_12nvate",
                emailParams
              );
              console.log("Email sent successfully");
            } catch (emailError) {
              console.warn(
                "Email sending failed, but payment was processed:",
                emailError
              );
            }
          }

          // Step 7: Show success message
          await Swal.fire({
            icon: "success",
            title: "Paiement Réussi !",
            html: `
              <div style="text-align: left; padding: 10px;">
                <p><strong>Transaction ID :</strong> ${
                  paymentData.transactionId
                }</p>
                <p><strong>Montant :</strong> ${paymentData.amount.toFixed(
                  2
                )} €</p>
                <p><strong>Méthode :</strong> ${paymentData.paymentMethod}</p>
                <p><strong>Date :</strong> ${paymentData.date} à ${
              paymentData.time
            }</p>
                <hr>
                <p style="color: #28a745; font-weight: bold;">✅ Reçu téléchargé automatiquement</p>
                <p style="color: #007bff;">📧 Email de confirmation envoyé</p>
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 15px;">
                  Vous allez être redirigé vers la page d'accueil dans quelques secondes...
                </p>
              </div>
            `,
            confirmButtonColor: "#28a745",
            confirmButtonText: "Parfait !",
            timer: 8000,
            timerProgressBar: true,
          });

          // Step 8: Redirect to home page
          setTimeout(() => {
            window.location.href = "home.html";
          }, 3000);

          return { success: true, data: paymentData };
        } catch (error) {
          console.error("Comprehensive payment processing failed:", error);

          await Swal.fire({
            icon: "error",
            title: "Erreur de Traitement",
            html: `
              <div style="text-align: left;">
                <p><strong>Une erreur s'est produite :</strong></p>
                <p style="color: #dc3545; font-size: 0.9em;">${error.message}</p>
                <hr>
                <p style="color: #6c757d; font-size: 0.9em;">
                  Veuillez vérifier vos informations et réessayer.
                  Si le problème persiste, contactez notre support.
                </p>
              </div>
            `,
            confirmButtonColor: "#dc3545",
            confirmButtonText: "Réessayer",
          });

          throw error;
        }
      }

      // Payment Method Selection
      function selectPaymentMethod(method) {
        // Remove previous selection
        document.querySelectorAll(".payment-method-card").forEach((card) => {
          card.classList.remove("selected");
        });

        // Add selection to clicked card
        document
          .querySelector(`[data-method="${method}"]`)
          .classList.add("selected");

        selectedPaymentMethod = method;
        document.getElementById("selectedPaymentMethod").value = method;

        // Update button text and show/hide M-PESA button
        const paymentButton = document.getElementById("paymentButton");
        const buttonText = document.getElementById("buttonText");
        const mpesaBtn = document.getElementById("mpesaBtn");

        if (method === "card") {
          buttonText.innerHTML = "Payer par carte";
          mpesaBtn.style.display = "none";
        } else if (method === "mobile") {
          buttonText.innerHTML = "Payer par M-PESA";
          mpesaBtn.style.display = "block";
        }

        // Enable button if form is valid
        updatePaymentButton();

        // Progress to step 2
        updateProgressStep(2);
      }

      // Form Validation
      function initializeFormValidation() {
        const nameInput = document.querySelector('input[name="to_name"]');
        const emailInput = document.querySelector('input[name="email"]');

        nameInput.addEventListener("input", validateName);
        nameInput.addEventListener("blur", validateName);

        emailInput.addEventListener("input", validateEmail);
        emailInput.addEventListener("blur", validateEmail);
      }

      function validateName() {
        const nameInput = document.querySelector('input[name="to_name"]');
        const formGroup = nameInput.closest(".form-group");
        const name = nameInput.value.trim();

        if (name.length < 2) {
          setValidationState(formGroup, "error");
          return false;
        } else {
          setValidationState(formGroup, "success");
          return true;
        }
      }

      function validateEmail() {
        const emailInput = document.querySelector('input[name="email"]');
        const formGroup = emailInput.closest(".form-group");
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!emailRegex.test(email)) {
          setValidationState(formGroup, "error");
          return false;
        } else {
          setValidationState(formGroup, "success");
          return true;
        }
      }

      function setValidationState(formGroup, state) {
        formGroup.classList.remove("error", "success");
        if (state) {
          formGroup.classList.add(state);
        }
        updateFormValidation();
      }

      function updateFormValidation() {
        const nameValid = validateName();
        const emailValid = validateEmail();
        isFormValid = nameValid && emailValid;
        updatePaymentButton();

        // If form becomes valid and payment method is selected, auto-enable button
        if (isFormValid && selectedPaymentMethod) {
          console.log("✅ Form is now complete and ready for submission");
        }
      }

      function updatePaymentButton() {
        const paymentButton = document.getElementById("paymentButton");
        const canProceed = isFormValid && selectedPaymentMethod;

        console.log("🔄 Updating payment button:", {
          isFormValid,
          selectedPaymentMethod,
          canProceed,
        });

        paymentButton.disabled = !canProceed;

        if (!canProceed && !selectedPaymentMethod) {
          document.getElementById("buttonText").innerHTML =
            "Sélectionnez une méthode de paiement";
        } else if (!canProceed && selectedPaymentMethod) {
          document.getElementById("buttonText").innerHTML =
            "Complétez le formulaire";
        } else if (canProceed) {
          // Update button text based on payment method
          if (selectedPaymentMethod === "card") {
            document.getElementById("buttonText").innerHTML =
              "<i class='fas fa-credit-card'></i> Payer par Carte";
          } else if (selectedPaymentMethod === "mobile") {
            document.getElementById("buttonText").innerHTML =
              "<i class='fas fa-mobile-alt'></i> Payer par M-PESA";
          } else {
            document.getElementById("buttonText").innerHTML =
              "<i class='fas fa-check'></i> Procéder au Paiement";
          }
        }
      }

      // Progress Step Management
      function updateProgressStep(step) {
        document.querySelectorAll(".progress-step").forEach((stepEl, index) => {
          stepEl.classList.remove("active", "completed");
          if (index + 1 < step) {
            stepEl.classList.add("completed");
          } else if (index + 1 === step) {
            stepEl.classList.add("active");
          }
        });
      }

      // AUTOMATIC RECEIPT GENERATION SYSTEM
      async function generateAutomaticReceipt(doc, receiptId, payload) {
        try {
          // Store receipt data in localStorage for future reference
          const receiptData = {
            id: receiptId,
            date: new Date().toISOString(),
            customerName: payload.to_name || "Client MDai",
            email: payload.email || "contact@mdai.xyz",
            course:
              payload.course_title ||
              localStorage.getItem("selectedCourseTitle") ||
              "Cours MDai",
            amount:
              payload.total_amount ||
              payload.amount ||
              localStorage.getItem("selectedCourseTotal") ||
              "0",
            paymentMethod: payload.payment_method || "Non spécifié",
          };

          // Store in localStorage with error handling
          try {
            let receipts = JSON.parse(
              localStorage.getItem("mdai_receipts") || "[]"
            );
            receipts.push(receiptData);
            localStorage.setItem("mdai_receipts", JSON.stringify(receipts));
          } catch (storageError) {
            console.warn(
              "Could not save receipt to localStorage:",
              storageError
            );
          }

          // Show processing animation
          Swal.fire({
            title: "🧠 Génération Automatique du Reçu",
            html: `
              <div style="padding:20px">
                <div class="lds-spinner">
                  <div></div><div></div><div></div><div></div><div></div><div></div>
                  <div></div><div></div><div></div><div></div><div></div><div></div>
                </div>
                <p style="margin-top:15px; font-size:1rem;">MDai traite automatiquement votre paiement...</p>
                <div style="margin-top:10px; font-size:0.9rem; color:#666;">
                  ✓ Génération du PDF...<br>
                  ✓ Envoi par email...<br>
                  ✓ Téléchargement automatique...
                </div>
              </div>`,
            allowOutsideClick: false,
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
          });

          // Wait for the animation to complete, then automatically process
          setTimeout(async () => {
            try {
              // Automatically save the PDF
              doc.save(`MDai_Receipt_${receiptId}.pdf`);

              // Show receipt preview (with timeout)
              try {
                await Promise.race([
                  showReceiptPreview(receiptData),
                  new Promise((_, reject) =>
                    setTimeout(() => reject(new Error("Preview timeout")), 5000)
                  ),
                ]);
              } catch (previewError) {
                console.warn("Receipt preview failed:", previewError);
              }

              // Show completion message
              Swal.fire({
                icon: "success",
                title: "✅ Paiement Réussi!",
                html: `
                  <div style="text-align: left; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <div style="text-align: center; margin-bottom: 15px;">
                      <i class="fas fa-check-circle" style="font-size: 48px; color: #28a745;"></i>
                    </div>
                    <p><strong>� N° Reçu:</strong> ${receiptId}</p>
                    <p><strong>� Client:</strong> ${receiptData.customerName}</p>
                    <p><strong>📧 Email:</strong> ${receiptData.email}</p>
                    <p><strong>� Montant:</strong> ${receiptData.amount}</p>
                    <p><strong>💾 Statut:</strong> <span style="color: #28a745;">PDF téléchargé automatiquement</span></p>
                    <hr style="margin: 15px 0;">
                    <p style="text-align: center; color: #28a745;"><strong>✅ Merci pour votre confiance en MDai!</strong></p>
                  </div>
                `,
                confirmButtonText: "Continuer vers l'accueil",
                confirmButtonColor: "#667eea",
                allowOutsideClick: false,
              }).then(() => {
                // Redirect to home page
                window.location.href = "home.html";
              });
            } catch (processError) {
              console.error("Processing error:", processError);
              Swal.fire({
                icon: "warning",
                title: "Traitement Partiellement Réussi",
                text: "Le paiement a été traité mais il y a eu un problème avec la génération du reçu.",
                confirmButtonColor: "#667eea",
              });
            }
          }, 3000);
        } catch (error) {
          console.error("Automatic receipt generation error:", error);
          Swal.fire({
            icon: "error",
            title: "Erreur de Génération",
            text: "Une erreur s'est produite lors de la génération automatique du reçu.",
            confirmButtonColor: "#667eea",
          });
        }
      }

      // RECEIPT PREVIEW SYSTEM
      async function showReceiptPreview(receiptData) {
        return new Promise((resolve) => {
          Swal.fire({
            title: "📄 Aperçu du Reçu",
            html: `
              <div style="text-align: left; background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 10px 0;">
                <div style="text-align: center; margin-bottom: 15px;">
                  <img src="images/MDai.png" alt="MDai Logo" style="width: 60px; height: 60px;">
                  <h3 style="color: #667eea; margin: 5px 0;">MDai Platform</h3>
                </div>
                <hr style="margin: 15px 0; border-color: #667eea;">
                <p><strong>📋 N° Reçu:</strong> ${receiptData.id}</p>
                <p><strong>👤 Client:</strong> ${receiptData.customerName}</p>
                <p><strong>📧 Email:</strong> ${receiptData.email}</p>
                <p><strong>📚 Cours:</strong> ${receiptData.course}</p>
                <p><strong>💰 Montant:</strong> ${receiptData.amount}</p>
                <p><strong>💳 Méthode:</strong> ${receiptData.paymentMethod}</p>
                <p><strong>📅 Date:</strong> ${new Date(
                  receiptData.date
                ).toLocaleString("fr-FR")}</p>
                <hr style="margin: 15px 0; border-color: #28a745;">
                <p style="text-align: center; color: #28a745;"><strong>✅ Paiement Confirmé</strong></p>
              </div>
            `,
            icon: "info",
            confirmButtonText: "Parfait!",
            confirmButtonColor: "#667eea",
            timer: 5000,
            timerProgressBar: true,
          }).then(() => {
            resolve();
          });
        });
      }

      // RECEIPT HISTORY ACCESS
      function viewReceiptHistory() {
        const receipts = JSON.parse(
          localStorage.getItem("mdai_receipts") || "[]"
        );

        if (receipts.length === 0) {
          Swal.fire({
            icon: "info",
            title: "Aucun Reçu Trouvé",
            text: "Vous n'avez pas encore de reçus enregistrés.",
            confirmButtonColor: "#667eea",
          });
          return;
        }

        const receiptsList = receipts
          .map(
            (receipt) => `
          <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px;">
            <strong>${receipt.id}</strong> - ${receipt.course}<br>
            <small>Montant: ${receipt.amount} | Date: ${new Date(
              receipt.date
            ).toLocaleDateString("fr-FR")}</small>
          </div>
        `
          )
          .join("");

        Swal.fire({
          title: "📄 Historique des Reçus",
          html: `<div style="max-height: 300px; overflow-y: auto;">${receiptsList}</div>`,
          confirmButtonText: "Fermer",
          confirmButtonColor: "#667eea",
          width: "600px",
        });
      }

      // System Initialization
      function initializePaymentSystem() {
        console.log("Initializing payment system...");

        // Check for required libraries
        const requiredLibraries = [
          { name: "jsPDF", check: () => typeof window.jspdf !== "undefined" },
          { name: "EmailJS", check: () => typeof emailjs !== "undefined" },
          { name: "SweetAlert2", check: () => typeof Swal !== "undefined" },
          { name: "QRCode", check: () => typeof QRCode !== "undefined" },
        ];

        const missingLibraries = requiredLibraries.filter(
          (lib) => !lib.check()
        );

        if (missingLibraries.length > 0) {
          console.warn(
            "Missing libraries:",
            missingLibraries.map((lib) => lib.name)
          );
        } else {
          console.log("All required libraries loaded successfully");
        }

        // Initialize EmailJS if available
        if (typeof emailjs !== "undefined") {
          emailjs.init("user_oskDomovicaVan111");
          console.log("EmailJS initialized");
        }

        // Initialize form validation
        if (typeof initializeFormValidation === "function") {
          initializeFormValidation();
        }

        // Initialize payment button state
        if (typeof updatePaymentButton === "function") {
          updatePaymentButton();
        }

        // Set up theme
        initializeTheme();

        console.log("Payment system initialization complete");
      }

      // Initialize theme
      function initializeTheme() {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
      }

      // Auto-initialize when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializePaymentSystem);
      } else {
        initializePaymentSystem();
      }
    </script>

    <script>
      function showMpesa() {
        document.getElementById("mpesaBox").classList.add("active");
      }
      function hideMpesa() {
        document.getElementById("mpesaBox").classList.remove("active");
      }
      function copyMpesa() {
        const number = document.querySelector(".mpesa-number").textContent;
        navigator.clipboard.writeText(number).then(() => {
          const feedback = document.getElementById("copy-feedback");
          feedback.style.display = "block";
          setTimeout(() => (feedback.style.display = "none"), 2000);
        });
      }
    </script>
  </body>
</html>
